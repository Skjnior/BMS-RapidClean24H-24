<div th:replace="~{admin/layout :: layout(~{::content})}">
    <div th:fragment="content">
        <!-- Flash Messages -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Back Button & Header -->
        <div class="mb-4">
            <a th:href="@{/admin/employees}" class="btn btn-outline-secondary mb-3">
                <i class="fas fa-arrow-left me-2"></i> Retour à la liste
            </a>
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h2 class="mb-2">
                        <i class="fas fa-user-circle me-2" style="color: #667eea;"></i>
                        <span th:text="${employee.fullName}">Nom Employé</span>
                    </h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-envelope me-2"></i>
                        <span th:text="${employee.email}">email@exemple.com</span>
                        <span class="ms-3">
                            <i class="fas fa-phone me-2"></i>
                            <span th:text="${employee.phone}">+33 6 00 00 00 00</span>
                        </span>
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <span th:if="${employee.enabled}" class="badge bg-success fs-6">
                        <i class="fas fa-check-circle me-1"></i> Actif
                    </span>
                    <span th:unless="${employee.enabled}" class="badge bg-danger fs-6">
                        <i class="fas fa-times-circle me-1"></i> Inactif
                    </span>
                    <span th:if="${employee.firstLogin}" class="badge bg-warning fs-6">
                        <i class="fas fa-exclamation-triangle me-1"></i> Première connexion
                    </span>
                    <a th:href="@{/admin/employees/{id}/edit(id=${employee.id})}" class="btn btn-primary">
                        <i class="fas fa-edit me-1"></i> Modifier
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column: Employee Info -->
            <div class="col-lg-4">
                <!-- Employee Card -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h5 class="mb-0">
                            <i class="fas fa-id-card me-2"></i> Informations Personnelles
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <div class="user-avatar mx-auto mb-3" 
                                 style="width:100px;height:100px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:2.5rem;box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                                <span th:text="${#strings.substring(employee.firstName,0,1) + #strings.substring(employee.lastName,0,1)}">AB</span>
                            </div>
                            <h4 class="mb-1" th:text="${employee.fullName}">Nom Complet</h4>
                            <span class="badge bg-primary" th:text="${employee.role.name()}">EMPLOYEE</span>
                        </div>
                        <hr>
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small">
                                <i class="fas fa-envelope me-2 text-info"></i>Email
                            </label>
                            <p class="mb-0">
                                <a th:href="'mailto:' + ${employee.email}" th:text="${employee.email}">email</a>
                            </p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small">
                                <i class="fas fa-phone me-2 text-success"></i>Téléphone
                            </label>
                            <p class="mb-0">
                                <a th:href="'tel:' + ${employee.phone}" th:text="${employee.phone}">Téléphone</a>
                            </p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small">
                                <i class="fas fa-calendar me-2 text-warning"></i>Date de création
                            </label>
                            <p class="mb-0" th:text="${#temporals.format(employee.createdAt, 'dd/MM/yyyy HH:mm')}">Date</p>
                        </div>
                        <div class="mb-0">
                            <label class="form-label fw-bold text-muted small">
                                <i class="fas fa-toggle-on me-2" style="color: #27ae60;"></i>Statut
                            </label>
                            <p class="mb-0">
                                <span th:if="${employee.enabled}" class="badge bg-success">
                                    <i class="fas fa-check-circle me-1"></i> Actif
                                </span>
                                <span th:unless="${employee.enabled}" class="badge bg-danger">
                                    <i class="fas fa-times-circle me-1"></i> Inactif
                                </span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Today's Status Card -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                        <h5 class="mb-0">
                            <i class="fas fa-clock me-2"></i> Statut d'Aujourd'hui
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${todayTracking}" class="today-status-content">
                            <div class="status-grid">
                                <div class="status-item arrival-status">
                                    <div class="status-icon-wrapper arrival-icon">
                                        <i class="fas fa-arrow-right-to-bracket"></i>
                                    </div>
                                    <div class="status-info">
                                        <label class="status-label">Arrivée</label>
                                        <div class="status-time" 
                                             th:text="${todayTracking.arrivalTime != null ? #temporals.format(todayTracking.arrivalTime, 'HH:mm') : '-- : --'}">
                                            --:--
                                        </div>
                                    </div>
                                </div>
                                <div class="status-item departure-status">
                                    <div class="status-icon-wrapper departure-icon">
                                        <i class="fas fa-arrow-right-from-bracket"></i>
                                    </div>
                                    <div class="status-info">
                                        <label class="status-label">Départ</label>
                                        <div class="status-time" 
                                             th:text="${todayTracking.departureTime != null ? #temporals.format(todayTracking.departureTime, 'HH:mm') : '-- : --'}">
                                            --:--
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div th:if="${todayTracking.arrivalTime != null and todayTracking.departureTime != null}" 
                                 class="status-duration">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="duration-label-small">
                                        <i class="fas fa-stopwatch me-2"></i>Durée totale
                                    </span>
                                    <span class="duration-value-small" th:text="${todayTracking.formattedDuration}">--:--</span>
                                </div>
                            </div>
                        </div>
                        <div th:unless="${todayTracking}" class="text-center py-4">
                            <div class="no-tracking-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <p class="text-muted mb-0 mt-3">Pas encore pointé aujourd'hui</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-bolt me-2 text-warning"></i> Actions Rapides
                        </h5>
                    </div>
                    <div class="card-body">
                        <a th:href="@{/admin/employees/{id}/time-tracking(id=${employee.id})}" 
                           class="btn btn-outline-primary w-100 mb-2">
                            <i class="fas fa-hourglass-end me-2"></i> Voir Pointages
                        </a>
                        <a th:href="@{/admin/employees/{id}/absences(id=${employee.id})}" 
                           class="btn btn-outline-warning w-100 mb-2">
                            <i class="fas fa-calendar-xmark me-2"></i> Voir Absences
                        </a>
                        <a th:href="@{/admin/employees/{id}/observations(id=${employee.id})}" 
                           class="btn btn-outline-danger w-100">
                            <i class="fas fa-exclamation-triangle me-2"></i> Voir Observations
                        </a>
                    </div>
                </div>
            </div>

            <!-- Right Column: Activity & Stats -->
            <div class="col-lg-8">
                <!-- Today's Activity Card -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i> Activité d'Aujourd'hui
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${todayTracking}" class="activity-timeline">
                            <div class="timeline-item">
                                <div class="timeline-icon arrival">
                                    <i class="fas fa-arrow-right-to-bracket"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="d-flex align-items-center mb-2">
                                        <h6 class="mb-0 me-3" style="color: #2c3e50; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                            Arrivée
                                        </h6>
                                    </div>
                                    <div class="time-display">
                                        <span class="time-value" 
                                              th:text="${todayTracking.arrivalTime != null ? #temporals.format(todayTracking.arrivalTime, 'HH:mm') : 'Non pointé'}">
                                            --:--
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-icon departure">
                                    <i class="fas fa-arrow-right-from-bracket"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="d-flex align-items-center mb-2">
                                        <h6 class="mb-0 me-3" style="color: #2c3e50; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                            Départ
                                        </h6>
                                    </div>
                                    <div class="time-display">
                                        <span class="time-value" 
                                              th:text="${todayTracking.departureTime != null ? #temporals.format(todayTracking.departureTime, 'HH:mm') : 'Non pointé'}">
                                            --:--
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div th:if="${todayTracking.arrivalTime != null and todayTracking.departureTime != null}" 
                                 class="duration-summary">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="duration-label">
                                        <i class="fas fa-stopwatch me-2"></i>Durée totale
                                    </span>
                                    <span class="duration-value" th:text="${todayTracking.formattedDuration}">--:--</span>
                                </div>
                            </div>
                        </div>
                        <div th:unless="${todayTracking}" class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Aucun pointage enregistré pour aujourd'hui
                        </div>
                    </div>
                </div>

                <!-- Absences Summary -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-days me-2"></i> Absences Ce Mois
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${monthlyAbsences == null or monthlyAbsences.isEmpty()}" class="alert alert-success mb-0">
                            <i class="fas fa-check-circle me-2"></i> Aucune absence ce mois
                        </div>
                        <div th:unless="${monthlyAbsences == null or monthlyAbsences.isEmpty()}">
                            <div class="mb-3">
                                <p class="text-muted mb-2">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Total: <strong th:text="${monthlyAbsences.size()}">0</strong> absence(s) ce mois
                                </p>
                            </div>
                            <div class="absence-list">
                                <div th:each="absence : ${monthlyAbsences}" class="absence-item">
                                    <div class="absence-date">
                                        <div class="text-center">
                                            <div class="badge bg-warning text-dark fs-6" 
                                                 style="padding: 8px 12px; display: block; margin-bottom: 5px;" 
                                                 th:text="${#temporals.format(absence.absenceDate, 'dd')}">
                                                01
                                            </div>
                                            <small class="text-muted" 
                                                   style="font-size: 11px;" 
                                                   th:text="${#temporals.format(absence.absenceDate, 'MMM')}">
                                                Déc
                                            </small>
                                        </div>
                                    </div>
                                    <div class="absence-info">
                                        <p class="mb-1">
                                            <span class="badge ms-2" 
                                                  th:classappend="${absence.type.name() == 'SICK_LEAVE' ? 'bg-danger' : (absence.type.name() == 'PAID_LEAVE' ? 'bg-info' : (absence.type.name() == 'HOLIDAY' ? 'bg-warning' : 'bg-secondary'))}"
                                                  th:text="${absence.type.label}">
                                                TYPE
                                            </span>
                                        </p>
                                        <p class="text-muted mb-0" 
                                           style="font-size: 13px; line-height: 1.5;" 
                                           th:text="${absence.reason != null and !absence.reason.isEmpty() ? absence.reason : 'Pas de motif indiqué'}">
                                            Motif
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observations Summary -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-circle me-2" style="color: #e74c3c;"></i> Observations Signalées
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${observations.isEmpty()}" class="alert alert-success mb-0">
                            <i class="fas fa-smile-wink me-2"></i> Aucune observation
                        </div>
                        <div th:unless="${observations.isEmpty()}">
                            <div class="observations-list">
                                <div th:each="obs : ${observations}" class="observation-item">
                                    <div class="observation-header">
                                        <h6 class="mb-1" th:text="${obs.title}">Titre</h6>
                                        <span class="badge" 
                                              th:classappend="${'bg-' + (obs.priority.name() == 'LOW' ? 'success' : (obs.priority.name() == 'MEDIUM' ? 'warning' : (obs.priority.name() == 'HIGH' ? 'danger' : 'dark')))}" 
                                              th:text="${obs.priority.label}">
                                            PRIORITY
                                        </span>
                                    </div>
                                    <p class="text-muted small mb-2" th:text="${obs.description}">Description</p>
                                    <div th:if="${obs.photoPath != null and !obs.photoPath.isEmpty()}" class="mb-2">
                                        <small class="text-muted d-block mb-2">
                                            <i class="fas fa-images me-1"></i>
                                            <span th:text="${obs.photoPaths.size()}">0</span> image(s) jointe(s)
                                        </small>
                                        <div class="d-flex flex-wrap gap-2">
                                            <div th:each="photoPath : ${obs.photoPaths}" 
                                                 th:if="${photoPath != null and !photoPath.isEmpty()}"
                                                 th:with="lastSlashIndex=${photoPath.lastIndexOf('/')}, filename=${lastSlashIndex >= 0 ? photoPath.substring(lastSlashIndex + 1) : photoPath}"
                                                 th:data-image-url="@{'/images/observations/' + ${filename}}"
                                                 class="observation-image-thumbnail"
                                                 style="position: relative; width: 60px; height: 60px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; cursor: pointer;">
                                                <img th:src="@{'/images/observations/' + ${filename}}" 
                                                     alt="Image observation" 
                                                     style="width: 100%; height: 100%; object-fit: cover;"
                                                     onerror="console.error('Erreur chargement image:', this.src); this.style.display='none';">
                                                <a th:href="@{'/images/observations/' + ${filename}}" 
                                                   th:download="${filename}"
                                                   class="btn btn-sm btn-primary"
                                                   style="position: absolute; bottom: 2px; right: 2px; padding: 2px 4px; font-size: 10px; line-height: 1;"
                                                   onclick="event.stopPropagation(); return false;">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted" th:text="${#temporals.format(obs.createdAt, 'dd/MM/yyyy HH:mm')}">Date</small>
                                        <span class="badge bg-secondary" th:text="${obs.status.label}">STATUS</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            .activity-timeline {
                position: relative;
                padding: 10px 0;
            }

            .timeline-item {
                display: flex;
                gap: 24px;
                padding: 24px 0;
                position: relative;
                align-items: flex-start;
                transition: all 0.3s ease;
            }

            .timeline-item:hover {
                transform: translateX(5px);
            }

            .timeline-item:not(:last-child)::after {
                content: '';
                position: absolute;
                left: 37px;
                top: 74px;
                width: 2px;
                height: calc(100% - 20px);
                background: linear-gradient(180deg, #e9ecef 0%, rgba(233, 236, 239, 0.3) 100%);
            }

            .timeline-icon {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                color: white;
                flex-shrink: 0;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transition: all 0.3s ease;
                position: relative;
                z-index: 1;
            }

            .timeline-item:hover .timeline-icon {
                transform: scale(1.1);
                box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            }

            .timeline-icon.arrival {
                background: linear-gradient(135deg, #11998e, #38ef7d);
            }

            .timeline-icon.departure {
                background: linear-gradient(135deg, #667eea, #764ba2);
            }

            .timeline-content {
                flex: 1;
                padding-top: 4px;
            }

            .timeline-content h6 {
                color: #2c3e50;
                font-size: 14px;
                margin-bottom: 12px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .time-display {
                margin-top: 4px;
            }

            .time-value {
                display: inline-block;
                font-size: 32px;
                font-weight: 700;
                color: #2c3e50;
                letter-spacing: 1px;
                font-family: 'Courier New', monospace;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                line-height: 1.2;
            }

            .duration-summary {
                margin-top: 32px;
                padding: 20px 24px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                transition: all 0.3s ease;
            }

            .duration-summary:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
            }

            .duration-label {
                color: rgba(255, 255, 255, 0.95);
                font-weight: 600;
                font-size: 15px;
                letter-spacing: 0.3px;
            }

            .duration-value {
                color: white;
                font-size: 28px;
                font-weight: 700;
                font-family: 'Courier New', monospace;
                letter-spacing: 1px;
            }

            /* Styles pour la section "Statut d'Aujourd'hui" */
            .today-status-content {
                padding: 8px 0;
            }

            .status-grid {
                display: flex;
                flex-direction: column;
                gap: 20px;
                margin-bottom: 24px;
            }

            .status-item {
                display: flex;
                align-items: center;
                gap: 16px;
                padding: 16px;
                background: #f8f9fa;
                border-radius: 12px;
                transition: all 0.3s ease;
                border-left: 4px solid transparent;
            }

            .status-item:hover {
                background: #e9ecef;
                transform: translateX(4px);
            }

            .status-item.arrival-status {
                border-left-color: #11998e;
            }

            .status-item.departure-status {
                border-left-color: #667eea;
            }

            .status-icon-wrapper {
                width: 50px;
                height: 50px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                color: white;
                flex-shrink: 0;
                box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            }

            .status-icon-wrapper.arrival-icon {
                background: linear-gradient(135deg, #11998e, #38ef7d);
            }

            .status-icon-wrapper.departure-icon {
                background: linear-gradient(135deg, #667eea, #764ba2);
            }

            .status-info {
                flex: 1;
            }

            .status-label {
                display: block;
                font-size: 12px;
                font-weight: 600;
                color: #6c757d;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 6px;
            }

            .status-time {
                font-size: 24px;
                font-weight: 700;
                color: #2c3e50;
                font-family: 'Courier New', monospace;
                letter-spacing: 1px;
                line-height: 1.2;
            }

            .status-duration {
                padding: 16px 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
            }

            .duration-label-small {
                color: rgba(255, 255, 255, 0.95);
                font-weight: 600;
                font-size: 14px;
                letter-spacing: 0.3px;
            }

            .duration-value-small {
                color: white;
                font-size: 22px;
                font-weight: 700;
                font-family: 'Courier New', monospace;
                letter-spacing: 1px;
            }

            .no-tracking-icon {
                width: 80px;
                height: 80px;
                margin: 0 auto;
                background: #f8f9fa;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 32px;
                color: #adb5bd;
            }

            .absence-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .absence-item {
                display: flex;
                gap: 20px;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 10px;
                align-items: flex-start;
                border-left: 4px solid #f39c12;
                margin-bottom: 12px;
                transition: all 0.3s ease;
            }
            
            .absence-item:hover {
                background: #e9ecef;
                transform: translateX(5px);
            }

            .absence-date {
                flex-shrink: 0;
                min-width: 60px;
            }

            .absence-info {
                flex-grow: 1;
            }

            .observations-list {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .observation-item {
                padding: 15px;
                background: #f8f9fa;
                border-radius: 8px;
                border-left: 4px solid #667eea;
                transition: all 0.3s ease;
            }
            
            .observation-item:hover {
                background: #e9ecef;
                transform: translateX(5px);
            }

            .observation-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }

            .observation-item h6 {
                color: #2c3e50;
                margin: 0;
            }
        </style>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const imageThumbnails = document.querySelectorAll('.observation-image-thumbnail');
                imageThumbnails.forEach(function(thumbnail) {
                    thumbnail.addEventListener('click', function(e) {
                        // Ne pas ouvrir si on clique sur le bouton de téléchargement
                        if (e.target.closest('a')) {
                            return;
                        }
                        const imageUrl = this.getAttribute('data-image-url');
                        if (imageUrl) {
                            window.open(imageUrl, '_blank');
                        }
                    });
                });
            });
        </script>
    </div>
</div>
